import time
import os
from pjscan import *
from traversal import *
from result_record import *
def sample_result(result):
    print(f"The number of paths is " + str(len(result)))
    str_ = ""
    for path_list in result:
        s = ""
        for entry in path_list[:-1]:
            s += entry['file_name']
            s += '::'
            s += str(entry['lineno'])
            s += '========>'
        s += path_list[-1]['file_name']
        s += '::'
        s += str(path_list[-1]['lineno'])
        str_ += s
        str_ += "\n"
    return str_

def test():
    if os.path.exists("_origin.json"):
        os.remove("_origin.json")
    if os.path.exists("_terminal.json"):
        os.remove("_terminal.json")
    with open("neo4j_default_config.yaml", 'w') as f:
        f.write("""NEO4J_HOST: 10.176.36.21
NEO4J_USERNAME: neo4j
NEO4J_PASSWORD: 123
NEO4J_PORT: 42004
NEO4J_PROTOCOL: bolt
NEO4J_DATABASE: neo4j""")
    cache_graph = BasicCacheGraph()
    analysis_framework = AnalysisFramework.from_yaml("neo4j_default_config.yaml", cache_graph=cache_graph)
    traversal = ForwardTraversal(analysis_framework = analysis_framework, recorder=ResultRecorder)
    traversal.run()
    result = traversal.recorder.get_report(origin_ids=traversal.origin_id,
                                               terminal_ids=traversal.terminal_id,
                                               analysis_framework=analysis_framework)
    with open("test.csv", "w") as f:
        f.write(sample_result(result))
    os.remove("neo4j_default_config.yaml")

if __name__ == '__main__':
    test()